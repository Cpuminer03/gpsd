#!/bin/sh
#
# flockdriver - conduct regression tests as an argent for a remote flocktest
#
# usage: flockdriver -d subdir
#
# The -d argument must be a subdirectory name
# The -m option must be a valid address for notification mail.
#
#  This will perform the following steps:
#
#  * If required, create the origin repo in a directory named after 
#     you beneath the test account home,
#
#   * git pull and build in that repo.
#
#   * make check, capturing the output
#
#   * mail the output back to you.
#
while getopts d opt
do
    case $opt in
        d) subdir=$2; shift; shift ;;
    esac
done

# Should yield a git URL valid for read-only access
origin="git://git.berlios.de/gpsd"

echo "Test begins: "`date`

site=`hostname --fqdn`
echo "Site: $site" 
echo "Directory: ${PWD}${subdir}"

# Set up or update the repo
if [ ! -d $subdir ]
then
    mkdir $subdir
    git clone $origin $subdir
else
    cd $subdir; git pull
fi

# Perform the test
if (./autogen.sh && make aivdm-regress)
then
    logmessage="Regression test succeeded"
else
    logmessage="Regression test failed"
fi

# Here's where we abuse CIA to do our notfications for us.

# Addresses for the e-mail
from="CIABOT-NOREPLY@${host}"
to="cia@cia.navi.cx"

# SMTP client to use
sendmail="sendmail -t -f ${from}"

# Should include all places sendmail is likely to lurk. 
PATH="$PATH:/usr/sbin/"

# Identify what just succeeded or failed
merged=$(git rev-parse HEAD)
rev=$(git describe ${merged} 2>/dev/null)
[ -z ${rev} ] && rev=${merged}
refname=$(git symbolic-ref HEAD 2>/dev/null)
refname=${refname##refs/heads/}

out="
<message>
  <generator>
    <name>GPSD Remote Test Flock Driver</name>
  </generator>
  <source>
    <project>GPSD</project>
    <branch>${refname}@${site}</branch>
  </source>
  <timestamp>`date`</timestamp>
  <body>
    <commit>
      <author>${subdir}</author>
      <revision>${rev}</revision>
      <log>${logmessage}</log>
    </commit>
  </body>
</message>"

sendmail=cat
${sendmail} << EOM
Message-ID: <${merged}.${subdir}@GPSD>
From: ${from}
To: ${to}
Content-type: text/xml
Subject: DeliverXML
${out}
EOM

echo "Test ends: "`date`

# End.
